%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%2345678901234567890123456789012345678901234567890123456789012345678901234567890
%        1         2         3         4         5         6         7         8

%\documentclass[letterpaper, 10 pt, conference]{mhs}  % Comment this line out if you need a4paper

\documentclass[a4paper, 10pt, conference, dvipdfmx]{mhs}      % Use this line for a4 paper

\IEEEoverridecommandlockouts                              % This command is only needed if 
% you want to use the \thanks command

\overrideIEEEmargins                                      % Needed to meet printer requirements.

%In case you encounter the following error:
%Error 1010 The PDF file may be corrupt (unable to open PDF file) OR
%Error 1000 An error occurred while parsing a contents stream. Unable to analyze the PDF file.
%This is a known problem with pdfLaTeX conversion filter. The file cannot be opened with acrobat reader
%Please use one of the alternatives below to circumvent this error by uncommenting one or the other
%\pdfobjcompresslevel=0
%\pdfminorversion=4

% See the \addtolength command later in the file to balance the column lengths
% on the last page of the document

%\renewcommand{\thesection}{\arabic{section}}
%\renewcommand{\thesubsection}{\thesection.\arabic{subsection}}
%\renewcommand{\thesubsubsection}{\arabic{subsubsection}}

% The following packages can be found on http:\\www.ctan.org
\usepackage{graphics} % for pdf, bitmapped graphics files
\usepackage[dvipdfmx]{graphicx}
\usepackage{bm}
\usepackage{epsfig} % for postscript graphics files
\usepackage{mathptmx} % assumes new font selection scheme installed
\usepackage{times} % assumes new font selection scheme installed
\usepackage{amsmath} % assumes amsmath package installed
\usepackage{amssymb}  % assumes amsmath package installed
\usepackage{here}
\usepackage{threeparttable}
\usepackage{caption}
\usepackage{cleveref}

\crefname{figure}{Fig}{Fig}
\crefname{table}{Table}{Table}


\captionsetup[table]{labelsep=period, labelfont=bf, justification=raggedright, singlelinecheck=off}
%\usepackage{titlesec}

%\titleformat*{\section}{\sc \bfseries \centering}
%\titleformat*{\subsection}{\sc \bfseries}

% \title{\Large \bf
% Preparation of Papers for MHS 2022\\
% \large33rd 2022 International Symposium on Micro-NanoMechatronics and Human Science\\
% (From Micro \& Nano Scale Systems to Robotics \& Mechatronics Systems)\\
% Symposium on ``Science of Soft Robots"\\
% Grant-in-Aid for Scientific Research on Innovative Areas, MEXT, Japan\\
% Symposium on ``HYPER-ADAPTABILITY"\\
% Grant-in-Aid for Scientific Research on Innovative Areas, MEXT, Japan
% }

\title{
  3D Point Cloudのみを使用した円柱と平面の交線導出
}

\author{All Author$^{1}$ and Researcher$^{2}$\\% <-this % stops a space
Department \& Affiliation, Address (Street, City \& Zip Code), Country\\\\}
\author{
  Tomohito Takubo, Hiroshi Shimamoto, Ryosuke Kusumoto, and Tetsuo Tsujioka \\
  Osaka Metropolitan University
}

\begin{document}
	
	\maketitle
	\thispagestyle{empty}
	\pagestyle{empty}
	
	
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	\begin{abstract}
    ロボットによる無人溶接を行うため、カメラによる溶接線の検出は大きな課題である。
    溶接線はさまざまなパターンがあるが、本研究では円柱を平面に対し垂直に溶接する
    場合の溶接線を検出する処理を提案する。

    深度カメラから取得した点群から円柱と平面を推定し、解析的に交線を計算する。
    この処理では、機械学習を使っていないので、検出に大量のデータセットが不要で、
    十分な点群が取得できれば交線が求めることができる。

    シミュレーションと、実機を用いて精度を評価した。
    シミュレーション環境では、$1mm$のずれ、実機では、$15mm$のずれとなった。
	\end{abstract}
	
	
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	
	\section{Introduction}
  近年の深刻な社会問題である少子高齢化により、今後の生産労働人口の激減が予想
  される。これへの対応措置として、ロボットによる作業代行が挙げられており、
  溶接作業もその例外ではない。

  ロボットによる自動溶接は、大きく分けてマニピュレーションと、溶接線の検出である、
  認識の２つの課題があるが、本論文では、溶接線の検出について述べる。

  本稿で想定している溶接とは、アーク溶接などの融接を考えている。
  これは、ロボットアームの手先に溶接機を取り付け、溶接線をなぞることにより、
  実現できる。
  また、突き合わせ溶接などの、平面を水平に溶接する場合は、
  カメラによる溶接線の検出が難しいが、母材が互いに垂直に配置されている
  隅肉溶接なら物体の形状を把握しやすい。
  そこで、本稿では数ある溶接物の形状の中でも、
  円柱と平面を隅肉溶接する処理を取り上げ、溶接線を検出する手法を提案する。

  近年の溶接に関する研究の動向は、Xuewuらが調査している\cite{survey_welding}。
  
  溶接物の材質にはさまざまな種類があるが、多くの場合、白や黒が多い。そのため、
  物体の検出に色の特徴量を使うのが困難であり、出力結果がロバストにならない。
  
  その点において、色の特徴量が少ない物体の3D Reconstructionのために、Shape
  from shading(SFS)を活用している研究がある\cite{welding_quality}。これは、この手法を用いて
  アーク溶接された溶接線を3D 復元し、溶接がどれだけ上手く行われたか、
  すなわち溶接線の質を評価しようとしたものである。

  Chenらは、検出した溶接線について、どこから溶接を開始するのかを決定する、
  溶接開始点の推定問題(SWE)への解法を提案している\cite{detect_welding_start_point}。
  縫い目状の溶接線とwork pieceの境界に対して、最小二乗法による関数
  のフィッティングをし、その関数の交点から溶接開始点を導出している。

  （他の溶接に関する研究を書く）

	
	\section{Problem Statement}
  本稿では隅肉溶接のアーク溶接をする上での溶接線の検出を考えている。
  したがって、溶接線は形状が異なる2物体のが交差してできる交線であると考えられる。

  今回は、円柱と平面を隅肉溶接することを考えているので、解決すべき課題は、
  \begin{quote}
    \begin{itemize}
      \item 深度カメラによる円柱と平面の推定
      \item 円柱と平面の交線の導出処理
    \end{itemize}
  \end{quote}
  の2つとなる。
  

	\section{Proposed Method}
  本研究の処理の流れは、\cref{fig:detection_process}に示す。処理は3ステップで行われる。

  まず、物体の撮影を行う。ノイズが少なくなるように撮影姿勢を工夫した。
  次に、外れ値をうまく除去しつつ、点群に含まれる円柱と平面の推定を行う。
  最後に、推定された円柱と平面から交線を導出する。

  この処理の流れから分かるように、この処理では機械学習を用いていない。
  したがって、大量のデータセットを準備したり、高性能なGPUが不要な処理になっている。

  続くsubsectionで、各処理の詳細を述べる。



\begin{figure}[htbp]
  \begin{center}
  \includegraphics[width=70mm]{./fig/difference.png}
  \caption{The process of detection}
  \label{fig:detection_process}
  \end{center}
\end{figure}
  

  \subsection{溶接物の撮影}
  シミュレーション環境では撮影姿勢がいかなるものでも、
  ノイズが少ない点群が得られるが、実際の環境では、撮影姿勢、撮影対象により
  波打ちや穴あきなどのノイズが多いデータになることがある。
  

  しかし、物体に対し垂直に撮影することで、いくらかはその波打ちを低減させることが
  できる。\cref{fig:difference_picture_pos}にその違いを示す。
  左は垂直面と水平面を別々に撮影して取得した画像、右は斜めから単一で撮影した画像
  である。図から明らかなように、単一で撮影した場合は形状がほとんどわからないのに
  対し、複数視点で撮影すれば、平面に垂直に立っている円柱の形状が現れているのが
  わかる。


  \begin{figure}[htbp]
    \begin{center}
    \includegraphics[width=70mm]{./fig/difference_picture_pos.png}
    \caption{The difference of depth data quality}
    \label{fig:difference_picture_pos}
    \end{center}
  \end{figure}
  
	 
	\subsection{円柱と平面の推定処理}
  深度カメラから送られてきた点群に対し、円柱と平面を推定する。
  本研究では、Random Sample Consensus(RANSAC)を使用して推定した\cite{ransac}。

  まず、処理を適用する前に、点群のDown Samplingを行う。
  これは点が入る密度を決定するVoxel size $L_{voxel}$四方の立方体で点群を
  分割する。

  平面と円柱を求めるRANSACでは、外れ値を含むデータを使っていても、それらを除去し、
  点群にフィットする円柱や平面などのモデルをうまく推定することができる。
  使用者は平面、円柱の推定の試行回数$N$、容認する誤差の範囲である閾値$\epsilon$
  を指定する。$N$が大きいと時間はかかるが、解を見つける可能性は上がり、$\epsilon$は
  小さいほどより点群に厳密にフィットする平面、円柱を探せるが、解が得られない
  可能性も上がる。これらのトレードオフを考慮し、パラメータの値を決定しなければ
  ならない。


  \subsection{溶接線の計算処理}
  RANSACで出力されるのは、平面、円柱を特定するためのパラメータである。
  平面は法線ベクトル$\bm{n}$と定数$k$が出力され、以下のような関係にある。
  \begin{align}
    \bm{x}\cdot \bm{n} + k = 0
  \end{align}
  円柱は、中心軸の方向ベクトル$d$と通る１点$a$、そしてその半径$r$が出力される。
  ただし、中心軸は
  \begin{align}
    \bm{x} = t\bm{d} + \bm{a} 
  \end{align}
  という関係にある。
  円柱と平面の数学的パラメータが求まったら、あとは解析的に交線を求めることが
  できる。

  まず、平面と円柱の中心軸の交点$\bm{r_{h}}$を求める。
  \begin{align}
    \bm{r_{h}} = -\frac{k + \bm{a}\cdot \bm{n}}{\bm{d}\cdot \bm{n}} \bm{d} + \bm{a}
  \end{align}
  次に、中心軸とロボット座標系のz軸(鉛直方向の軸)との成す角$\theta_{c}$を求める。
  \begin{align}
    \theta_{c} = cos^{-1}\frac{\bm{d}\cdot \bm{e_{z}}}{||\bm{d}|| ||\bm{e_{z}}||}
  \end{align}
  $\bm{r}$を軸とし$\theta$回転する回転行列を$R(\bm{r}, \theta)$として、以下の回転行列
  $R_{c}$を計算する
  \begin{align}
    R_{c} = (normalize(\bm{d} \times \bm{e_{z}}), -\theta_{c})
  \end{align}
  $\bm{r}$だけ平行移動する行列$T(\bm{r})$を定義し、以下の変換行列$A$を求める。
  \begin{align}
    A = T(-\bm{r_{h}}) R_{c}
  \end{align}
  すると、交線となる円の点群$P_{c}$と$\bm{p_{i}} \in P_{c}$は、
  \begin{align}
    \bm{\bar{p}_{i}} &= cos \theta_{i} \bm{e_{x}} + sin \theta_{i} \bm{e_{y}} \\
    \bm{p_{i}} &= A^{-1} \bm{\bar{p}_{i}} 
  \end{align}

  \section{Experiment And Result}
  実験はシミュレーションと、実機のそれぞれについて行った。
  提案手法では、複数視点で点群の波打ちを低減させているが、比較のために、45度の
  角度から１度の撮影で溶接線を検出した場合も行った。
  
  \subsection{Experiment Setup}
  本研究ではUFactory製の6DOF robot armであるxArmを使用した(\cref{fig:hardware_setup})。
  溶接物の撮影には、Realsense d455を使用し、これはArmの手先に取り付けられている。
  また、手先にはさらに溶接のためのトーチが取り付けられ、アーク溶接などを実行
  する際には、手先に高い正の電圧を、母材には負の電圧をかけ、アーク放電を発生させる。
  ここで、本研究では溶接線の検出がメインであるので、溶接作業のマニピュレーション
  までは行わない。
	
  実験に使用したモデルは黒革の平面上に円柱が垂直に立てられたモデル
  を使用した。
  ロボットアーム、溶接物の配置の関係は(\cref{fig:weld_pos})のようである。

  ロボットの操作のAPIにはROSを使用し、シミュレーション環境には、Gazeboを用いた。


  \begin{figure}[htbp]
    \begin{center}
    \includegraphics[width=70mm]{./fig/hardware_setup.png}
    \caption{hardware setup}
    \label{fig:hardware_setup}
    \end{center}
  \end{figure}

  \begin{figure}[htbp]
    \begin{center}
    \includegraphics[width=70mm]{./fig/weld_pos.png}
    \caption{The position of robot and weld object}
    \label{fig:weld_pos}
    \end{center}
  \end{figure}

  
  \subsection{Parameters Setting}
  RANSACでは、推定するのにパラメータを指定しなければならない。本研究では、
  いくつかの試行を行った結果、\cref{table:ParametersSetting}のように定めた。

  \begin{table}[hbtp]
		\caption{Parameters Setting}
		\label{table:ParametersSetting}
		\centering
		\normalsize
		\begin{tabular}{cll}
      \hline
      parameter name & value  \\
      \hline 
      \hline
      $L_{voxel}$ & 0.002 \\
      $N$ & 1000 \\
      $\epsilon$ & 0.001 \\
      \hline
		\end{tabular}
	\end{table}

  \subsection{Results and comparison}
  試行を15回繰り返し、その平均をとった。
  その結果を\cref{table:experiment_result}に示す。
  ただし、Value 1は円柱の中心軸と平面との交点の真値とのずれ、
  Value 2は円柱の半径の真値とのずれ、Value 3は円柱の中心軸とロボット座標系
  のz軸との成す角である。すべて0であれば良く、Value 3は円柱が垂直に立っている
  ことをどれだけ精度良く検出できているかを表している。

  シミュレーション結果では、誤差はほとんど見られなかった。
  実機においては、単一視点より複数視点視点で点群を取得するほうが
  結果がよくなっている。これはやはり取得する点群の波打ち、穴あきが減少したために、
  RANSACによる円柱と平面の推定の精度が向上したためであると考えられる。
  シミュレーション結果での高精度からも、カメラから得られる点群の精度が大きく
  結果に影響を与えることが分かる。

  
\begin{table}[hbtp]
  \caption{Experiment Result(deviation of  the true value)}
  \label{table:experiment_result}
  \centering
  \normalsize
  \begin{tabular}{cccc}
    \hline
    type &  Value 1[m] & Value 2[m] & Value 3[deg] \\
    \hline 
    \hline
    simulation & $6.74\times 10^{-5}$ & $1.11\times 10^{-5}$ & $9.96\times 10^{-3}$ \\
    単一視点 & 0.001 & 0.050 & 0.00 \\
    複数視点 & 0.001 & 0.050 & 0.00 \\
    \hline
  \end{tabular}
\end{table}

  \section{Conclusion}
  本研究では深度カメラから取得した点群のみを使用して溶接線を導出する処理を提案
  した。この処理では、機械学習を用いていないので、高性能なGPUや大量のデータセット
  が不要であった。
  
  実験では、シミュレーションと現実環境の２種類で行い、現実環境では点群の取得
  方法を単一視点と複数視点の２つの方法で行った。結果は、シミュレーション環境では
  誤差はほとんど見られなかったが、実機では良くて$15mm$の誤差となった。
  実際に溶接作業で使うにはさらに精度を上げる必要がある。実験結果からわかったように、
  点群の精度が結果の良さに影響するため、カメラの性能が上がれば結果の精度も向上
  すると考えられる。

  また、カメラで点群を取得する際、物体に対して垂直になるように別々に
  撮影するほうが、斜めから単一で撮影するより精度が向上した。

  
	% \subsection{Paper Type}
	% Authors can select the paper type between short paper and full paper. Paper type cannot be changed after the notification of acceptance.\\
	
	% \begin{itemize}	
	% \item Short paper: 1-3 pages. Paper is not uploaded to IEEE Xplore.
	% \item Full paper: 4-6 pages. Paper could be uploaded to IEEE Xplore if the authors want to. 
	% \end{itemize}

	% \section{TYPE SIZE AND FONTS}
	% Try to follow the type sizes as below as best you can:\\
	% \begin{table}[hbtp]
	% 	\caption{size of the font}
	% 	\label{table:FONTSIZE}
	% 	\centering
	% 	\normalsize
	% 	\begin{tabular}{lrl}
	% 		Paper Title:&		14 points,& bold\\
	% 		Authors' Names:&		12 points, &Italic\\
	% 		Authors' Affiliation:&  	10 points, &regular\\
	% 		Main Text:&		10 points, &regular\\
	% 		Or&	 9 points, &regular (optional)\\
	% 		Section Title:&		10 points, &bold\\
	% 		Abstract:&		10 points, &bold\\
	% 		Figure Captions:&	 	 8 points, &regular\\
	% 		Footnotes:&		 8 points, &regular\\
	% 	\end{tabular}
	% \end{table}

	
	% The manuscript must use fonts that allow embedding and subsetting (including the base fonts). Failure to embed and subset fonts is the biggest obstacle to PDF compliance with IEEE Xplore.\\
	
	% \begin{itemize}
	% 	\item All Type 1 fonts are embeddable.
	% 	\item Only some TrueType fonts are embeddable.
	% 	\item Open Type fonts are acceptable as long as they are embedded subset.
	% 	\item Do not embed fonts in a graphic file.
	% \end{itemize}
	
	% \section{Graphics}
	% The graphics of the manuscript should have the resolution of 300 dpi or higher. Do not link to some graphic directly to the article outside the manuscript. Insert all of the graphics into the manuscript.
	
	% \section{Headings}
	% \subsection{Title of your paper and the abstract}
	% Center the title on the page so as to run across the upper portion of the paper. The name of the authors, their affiliation, their address and countries should be also centered using fonts described in the previous section. A brief abstract with one column width should be included as the first paragraph of the paper.\\
	
	% \subsection{Major Headings and Subheadings}
	% Major headings are centered in the column. Subheadings are placed flash on the left margin of the column on a separate line.\\
	% In the TEX template, \textit{section}, and \textit{subsection} are configured for the indication.
	
	% \section{Copyright}
	% The accepted full papers shall become the exclusive copy right of the IEEE Robotics and Automation Society and may not be reproduced elsewhere without the Society’s permission.
	
	% \section{DUE DATE}
	% All authors are strictly required to keep the deadline. Final manuscript and abstract with IEEE Copyright Form should be submitted by July 15, 2022.
	
	
	\addtolength{\textheight}{-12cm}   % This command serves to balance the column lengths
	% on the last page of the document manually. It shortens
	% the textheight of the last page by a suitable amount.
	% This command does not take effect until the next page
	% so it should come on the page before the last. Make
	% sure that you do not shorten the textheight too much.
	
	%\section*{APPENDIX}
	
	
	
	\section*{ACKNOWLEDGMENT}
  甚深微妙なる叡智のもと、一切の苦厄を度されただけでなく、
  大変丁寧なご指導をくださった辻岡哲夫准教授に熱く御礼申し上げます。
	
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	
	% The template will number citations consecutively within brackets \cite{c1}. The sentence punctuation follows the bracket \cite{c2}. Refer simply to the reference number, as in \cite{c3}--do not use ``Ref. \cite{c3}" or ``reference \cite{c3}" except at the beginning of a sentence: ``Reference \cite{c3} was the first . . ."
	
	
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	
	\begin{thebibliography}{99}
    \bibitem{survey_welding}
    Xuewu Wang, Xin Zhou, Zelong Xia and, Xingsheng Gu, "A survey of welding robot
    intelligent path optimization," Journal of Manufacturing Prcoess, 63, 14-23, 2021.

    \bibitem{welding_quality}
    Lei Yang, En Li, Teng Long, Junfeng Fan Yijian Mao, Zaojun Fang, and Zize Liang, 
    "A welding quality detection method for arc welding robot based on 3D reconstruction
    with SFS algorithm," Int J Adv Manuf Technol (2018) 94:1209-1220

    \bibitem{detect_welding_start_point}
    X.Z. Chen, "The autonomous detection and guiding of start welding position for
      arc welding robot," Industrial Robot: An International Journal 37/1 (2010) 70-78

    \bibitem{ransac}
    A. M. Fischler and C. R. Bolles, “Random Sample Consensus: A Paradigm for Model Fitting 
    with Applications to Image Analysis and Automated Cartography,” Communications
    of the ACM, Vol. 24, No.6, pp. 381–395, 1981.



	\end{thebibliography}
	
	
	
	
\end{document}